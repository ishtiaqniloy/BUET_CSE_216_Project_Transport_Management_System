CREATE TYPE PAYMENT_INFO_OBJECT AS OBJECT(
				OBJECT_PAYMENT_NO NUMBER,
				OBJECT_AMOUNT NUMBER,
				OBJECT_PAYMENT_DATE DATE,
				OBJECT_HISTORY_NO NUMBER,
				OBJECT_DESCRIPTION VARCHAR2(50),
				OBJECT_TYPE VARCHAR2(50)
);
/ 
CREATE TYPE PAYMENT_TABLE IS TABLE OF PAYMENT_INFO_OBJECT;
/


CREATE OR REPLACE 
	FUNCTION GeneratePaymentTable
	RETURN PAYMENT_TABLE PIPELINED IS
	PAYMENT_ROW PAYMENT_INFO_OBJECT;
	DESCR VARCHAR2(50);

	BEGIN
		FOR R IN (SELECT * FROM PAYMENT ORDER BY PAYMENT_NO)
		LOOP
			IF(R.HISTORY_NO < 2000) THEN
				SELECT S.NAME INTO DESCR FROM LICENSESERVICEHISTORY H JOIN SERVICE S ON (H.SERVICE_ID = S.SID) WHERE H.ENTRY_NO = R.HISTORY_NO ;
			ELSIF (R.HISTORY_NO < 3000) THEN
				SELECT S.NAME INTO DESCR FROM VEHICLESERVICEHISTORY H JOIN SERVICE S ON (H.SERVICE_ID = S.SID) WHERE H.ENTRY_NO = R.HISTORY_NO;
			ELSE
				SELECT P.NAME INTO DESCR FROM PENALTYHISTORY H JOIN PENALTY P ON (H.PENALTY_ID = P.PID) WHERE H.ENTRY_NO = R.HISTORY_NO;
			END IF;
			PIPE ROW(PAYMENT_INFO_OBJECT(R.PAYMENT_NO, R.AMOUNT, R.PAYMENT_DATE, R.HISTORY_NO, DESCR , R.TYPE)) ;
		END LOOP;

END;
/

SELECT * from TABLE (GeneratePaymentTable);
