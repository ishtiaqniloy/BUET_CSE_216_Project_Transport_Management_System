
CREATE TYPE YEARLY_SUMMARY_OBJECT AS OBJECT(
				OBJECT_YEAR_NO NUMBER,
				OBJECT_VEHICLE_NO NUMBER,
				OBJECT_LICENSE_NO NUMBER,
				OBJECT_PENALTY_NO NUMBER,
				OBJECT_VEHICLE_SERVICE_NO NUMBER,
				OBJECT_LICENSE_SERVICE_NO NUMBER
);
/ 
CREATE TYPE YEARLY_SUMMARY_TABLE IS TABLE OF YEARLY_SUMMARY_OBJECT;
/



CREATE OR REPLACE 
	FUNCTION GenerateYearlySummary
	RETURN YEARLY_SUMMARY_TABLE PIPELINED IS
			i NUMBER;
			VEHICLE_NUM NUMBER;
			LICENSE_NUM NUMBER;
			PENALTY_NUM NUMBER;
			VEHICLE_SERVICE_NUM NUMBER;
			LICENSE_SERVICE_NUM NUMBER;

	BEGIN
		i  := 1970;
		while i <= EXTRACT(YEAR FROM SYSDATE)
		LOOP
				SELECT COUNT(V.REG_NO) INTO VEHICLE_NUM FROM VEHICLE V WHERE EXTRACT(YEAR FROM V.REG_DATE) = i;
				SELECT COUNT(L.ISSUE_DATE) INTO LICENSE_NUM FROM LICENSE L WHERE EXTRACT(YEAR FROM L.ISSUE_DATE) = i;
				SELECT COUNT(P.ENTRY_NO) INTO PENALTY_NUM FROM PENALTYHISTORY P WHERE EXTRACT(YEAR FROM P.PENALTY_DATE) = i;
				SELECT COUNT(V.ENTRY_NO) INTO VEHICLE_SERVICE_NUM FROM VEHICLESERVICEHISTORY V WHERE EXTRACT(YEAR FROM V.SERVICE_DATE) = i;
				SELECT COUNT(L.ENTRY_NO) INTO LICENSE_SERVICE_NUM FROM LICENSESERVICEHISTORY L WHERE EXTRACT(YEAR FROM L.SERVICE_DATE) = i;
				PIPE ROW(YEARLY_SUMMARY_OBJECT(i, VEHICLE_NUM, LICENSE_NUM, PENALTY_NUM, VEHICLE_SERVICE_NUM, LICENSE_SERVICE_NUM));
				i := i+1 ;
		END LOOP;

END;
/


SELECT * from TABLE (GenerateYearlySummary);
